<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Visualização de formulário para credenciais -->
    <record id="view_ai_system_credentials_form" model="ir.ui.view">
        <field name="name">ai.system.credentials.form</field>
        <field name="model">ai.system.credentials</field>
        <field name="arch" type="xml">
            <form string="Credenciais do Sistema de IA">
                <header>
                    <button name="action_test_connection" string="Testar Conexão" type="object" class="oe_highlight"/>
                    <button name="action_sync_to_webhook" string="Sincronizar com Serviço de Configuração" type="object" class="btn btn-primary"/>
                    <button name="action_sync_to_yaml" string="Sincronizar com YAML (Legado)" type="object" class="btn btn-secondary"/>
                    <field name="sync_status" widget="statusbar" statusbar_visible="not_synced,synced,error"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="open_config_viewer" type="object"
                                string="Visualizar Configurações"
                                class="oe_stat_button" icon="fa-cogs"/>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Nome das Credenciais"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="account_id"/>
                            <field name="token"/>
                            <field name="client_name"/>
                            <field name="business_area"/>
                            <field name="business_area_other" attrs="{'invisible': [('business_area', '!=', 'other')], 'required': [('business_area', '=', 'other')]}"/>
                        </group>
                        <group>
                            <field name="active"/>
                            <field name="last_accessed" readonly="1"/>
                            <field name="last_sync" readonly="1" attrs="{'invisible': [('sync_status', '=', 'not_synced')]}"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Credenciais Odoo" name="odoo_credentials">
                            <group>
                                <group>
                                    <field name="odoo_url"/>
                                    <field name="odoo_db"/>
                                    <field name="odoo_username"/>
                                </group>
                                <group>
                                    <field name="odoo_password" password="True"/>
                                    <field name="odoo_api_key" password="True"/>
                                    <field name="timeout"/>
                                    <field name="verify_ssl"/>
                                </group>
                            </group>
                        </page>
                        <page string="Configurações Adicionais" name="additional_settings">
                            <group string="URLs dos Serviços">
                                <group>
                                    <field name="ai_system_url" placeholder="https://ai-system.example.com" help="URL do sistema principal de IA (porta 8001)"/>
                                    <field name="config_service_url" placeholder="http://localhost:8002" help="URL do serviço de configuração (porta 8002)"/>
                                    <field name="config_service_api_key" password="True" placeholder="development-api-key" help="Chave de API para autenticação no serviço de configuração"/>
                                    <field name="vectorization_service_url" placeholder="http://localhost:8003" help="URL do serviço de vetorização (porta 8003)"/>
                                    <field name="vectorization_service_api_key" password="True" placeholder="development-api-key" help="Chave de API para autenticação no serviço de vetorização"/>
                                    <field name="use_ngrok"/>
                                    <field name="ngrok_url" attrs="{'invisible': [('use_ngrok', '=', False)], 'required': [('use_ngrok', '=', True)]}" placeholder="https://xxxx-xxx-xxx.ngrok.io"/>
                                </group>
                            </group>
                            <group string="Armazenamento">
                                <group>
                                    <field name="qdrant_collection"/>
                                </group>
                                <group>
                                    <field name="redis_prefix"/>
                                </group>
                            </group>
                        </page>
                        <page string="Redes Sociais" name="social_media">
                            <group string="Facebook">
                                <group>
                                    <field name="facebook_app_id"/>
                                    <field name="facebook_app_secret" password="True"/>
                                </group>
                                <group>
                                    <field name="facebook_access_token" password="True"/>
                                </group>
                            </group>
                            <group string="Instagram">
                                <group>
                                    <field name="instagram_client_id"/>
                                    <field name="instagram_client_secret" password="True"/>
                                </group>
                                <group>
                                    <field name="instagram_access_token" password="True"/>
                                </group>
                            </group>
                        </page>
                        <page string="Marketplaces" name="marketplaces">
                            <group string="Mercado Livre">
                                <group>
                                    <field name="mercadolivre_app_id"/>
                                    <field name="mercadolivre_client_secret" password="True"/>
                                </group>
                                <group>
                                    <field name="mercadolivre_access_token" password="True"/>
                                </group>
                            </group>
                        </page>
                        <page string="Mapeamentos de Canal" name="channel_mappings">
                            <field name="channel_mapping_ids" context="{'default_credential_id': active_id, 'default_business_area': business_area}">
                                <tree>
                                    <field name="chatwoot_account_id"/>
                                    <field name="chatwoot_inbox_id"/>
                                    <field name="business_area"/>
                                    <field name="is_fallback"/>
                                    <field name="sync_status"/>
                                    <field name="active"/>
                                </tree>
                            </field>
                            <div class="alert alert-info" role="alert">
                                <p><strong>Mapeamentos de Canal:</strong> Usados para direcionar mensagens do Chatwoot para o sistema de IA.</p>
                                <ul>
                                    <li><strong>ID da Conta no Chatwoot:</strong> ID numérico da conta no Chatwoot (ex: 1, 2, 3)</li>
                                    <li><strong>ID da Caixa de Entrada:</strong> ID numérico da caixa de entrada específica (opcional)</li>
                                    <li><strong>Área de Negócio:</strong> Deve corresponder à área de negócio da credencial</li>
                                    <li><strong>É Fallback:</strong> Usado quando nenhum mapeamento específico for encontrado</li>
                                </ul>
                                <p>Após criar os mapeamentos, clique no botão <strong>Sincronizar com Serviço de Configuração</strong> acima para enviar todos os mapeamentos.</p>
                            </div>
                        </page>
                        <page string="Notas" name="notes">
                            <field name="notes"/>
                        </page>
                        <page string="Status de Sincronização" name="sync_status_page" attrs="{'invisible': [('sync_status', '!=', 'error')]}">
                            <group string="Detalhes do Erro">
                                <field name="error_message" readonly="1" nolabel="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Visualização de árvore para credenciais -->
    <record id="view_ai_system_credentials_tree" model="ir.ui.view">
        <field name="name">ai.system.credentials.tree</field>
        <field name="model">ai.system.credentials</field>
        <field name="arch" type="xml">
            <tree string="Credenciais do Sistema de IA">
                <field name="name"/>
                <field name="account_id"/>
                <field name="client_name"/>
                <field name="business_area"/>
                <field name="odoo_url"/>
                <field name="odoo_db"/>
                <field name="last_accessed"/>
                <field name="active"/>
            </tree>
        </field>
    </record>

    <!-- Visualização de pesquisa para credenciais -->
    <record id="view_ai_system_credentials_search" model="ir.ui.view">
        <field name="name">ai.system.credentials.search</field>
        <field name="model">ai.system.credentials</field>
        <field name="arch" type="xml">
            <search string="Credenciais do Sistema de IA">
                <field name="name"/>
                <field name="account_id"/>
                <field name="client_name"/>
                <field name="token"/>
                <filter string="Ativos" name="active" domain="[('active', '=', True)]"/>
                <filter string="Inativos" name="inactive" domain="[('active', '=', False)]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Área de Negócio" name="group_by_business_area" context="{'group_by': 'business_area'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Visualização de árvore para logs de acesso -->
    <record id="view_ai_credentials_access_log_tree" model="ir.ui.view">
        <field name="name">ai.credentials.access.log.tree</field>
        <field name="model">ai.credentials.access.log</field>
        <field name="arch" type="xml">
            <tree string="Logs de Acesso às Credenciais" create="false" edit="false" delete="false">
                <field name="access_time"/>
                <field name="credential_id"/>
                <field name="user_id"/>
                <field name="ip_address"/>
                <field name="operation"/>
                <field name="success"/>
            </tree>
        </field>
    </record>

    <!-- Visualização de formulário para logs de acesso -->
    <record id="view_ai_credentials_access_log_form" model="ir.ui.view">
        <field name="name">ai.credentials.access.log.form</field>
        <field name="model">ai.credentials.access.log</field>
        <field name="arch" type="xml">
            <form string="Log de Acesso às Credenciais" create="false" edit="false" delete="false">
                <sheet>
                    <group>
                        <group>
                            <field name="access_time"/>
                            <field name="credential_id"/>
                            <field name="operation"/>
                        </group>
                        <group>
                            <field name="user_id"/>
                            <field name="ip_address"/>
                            <field name="success"/>
                        </group>
                    </group>
                    <group string="Detalhes do Erro" attrs="{'invisible': [('success', '=', True)]}">
                        <field name="error_message" nolabel="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Visualização de pesquisa para logs de acesso -->
    <record id="view_ai_credentials_access_log_search" model="ir.ui.view">
        <field name="name">ai.credentials.access.log.search</field>
        <field name="model">ai.credentials.access.log</field>
        <field name="arch" type="xml">
            <search string="Logs de Acesso às Credenciais">
                <field name="credential_id"/>
                <field name="user_id"/>
                <field name="ip_address"/>
                <filter string="Sucesso" name="success" domain="[('success', '=', True)]"/>
                <filter string="Falha" name="failure" domain="[('success', '=', False)]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Credencial" name="group_by_credential" context="{'group_by': 'credential_id'}"/>
                    <filter string="Usuário" name="group_by_user" context="{'group_by': 'user_id'}"/>
                    <filter string="Operação" name="group_by_operation" context="{'group_by': 'operation'}"/>
                    <filter string="Data" name="group_by_date" context="{'group_by': 'access_time:day'}"/>
                </group>
            </search>
        </field>
    </record>
</odoo>
